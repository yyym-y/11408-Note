# 数据通路

---

## 1. 指令周期的数据流

在 CPU 执行指令的过程中，**数据流**指的是数据在各个功能部件之间的流动路径。这种流动主要分为三类：

* **寄存器与寄存器之间**：例如数据从一个通用寄存器 (`R0`) 传送到另一个通用寄存器 (`R1`)，或从 `PC` 传送到 `MAR`。
* **寄存器与主存之间**：例如数据从主存读入 `MDR`，或从 `MDR` 写入主存。
* **寄存器与 ALU 之间**：例如操作数从 `ACC` 或通用寄存器输入到 `ALU` 进行运算，或运算结果从 `ALU` 输出到 `ACC`。

* **控制信号来源**：所有数据流动都由**控制单元 (CU)** 通过**控制总线**发出相应的**微操作信号**来精确控制，确保数据在正确的时间、从正确的源头流向正确的目的地。
* **阶段特性**：不同指令阶段（取指、间址、执行、中断）的数据流向可能不同，但都通过**地址总线、数据总线、控制总线**来完成传输。

---

## 2. 数据通路

### 2.1 基本概念

* **定义**：**数据通路**是指数据在 CPU 内部各个**功能部件之间传送的路径**。在分析数据通路时，需要明确数据流动的**起点、途径的部件和终点**。
* **控制信号分类**：控制数据流动的信号分为两类：
    * **输入控制信号**（`xx_in`）：控制数据**流入**某个寄存器，例如 `PCin`（允许数据写入 PC）、`ACCin`（允许数据写入 ACC）。
    * **输出控制信号**（`xx_out`）：控制数据**从**某个寄存器**流出**到总线或其他部件，例如 `PCout`（PC 内容输出到总线）、`ACCout`（ACC 内容输出到总线）。
* **实现方式**：所有这些控制信号均由**微操作信号发生器**产生，并通过专用的连线连接到各个寄存器的输入/输出端。

### 2.2 单总线结构

* **工作特点**：在**单总线结构**的 CPU 内部，所有功能部件（如寄存器、ALU 等）**共享同一条内部总线**。这意味着在**同一时刻，仅允许一对部件进行数据交换**，具有独占性。
* **扩展方案**：为了提高并行性，可以采用**多总线结构**（如三总线），从而支持多组部件同时进行数据传输。
* **对比方案**：**专用数据通路**（点对点直连）可以完全避免总线冲突，但会显著增加硬件的复杂性和布线难度。

### 2.3 总线分类

* **内部总线**：指 **CPU 内部**各部件间的传输通道（例如寄存器与 ALU 之间的通路）。它主要负责 CPU 内部的数据移动。
* **系统总线**：指 **CPU 与主存、I/O 接口等外部设备间**的传输通道。它负责 CPU 与外部世界的通信。
* **典型部件**：在数据通路中常见的核心部件包括：
    * **暂存寄存器 (Y/Z)**：用于运算的中间结果或操作数的临时暂存，尤其在单总线结构中必不可少。
    * **PSW (程序状态字寄存器)**：存储运算产生的标志位（如进位、零、符号、溢出等）。
    * **MAR (存储器地址寄存器)**：存储要访问的内存地址。
    * **MDR (存储器数据寄存器)**：存储从内存读取的数据或要写入内存的数据。

### 2.4 实现要点

* **时序控制**：所有部件的工作节奏必须通过**时序系统**精确协调，确保微操作按正确的时间点发生。
* **信号同步**：所有控制信号（如 `IRin`、`MDRout`）必须严格同步，在正确的时钟周期内有效，以保证数据传输的正确性。
* **典型流程 (取指为例)**：
    1.  控制器发出 `PCout` 和 `MARin` 信号。
    2.  **程序计数器 (PC)** 的内容通过内部总线存入 `MAR`。
    3.  存储器按 `MAR` 中的地址取出指令，通过数据总线送入 `MDR`。
    4.  控制器发出 `MDRout` 和 `IRin` 信号，将 `MDR` 中的指令送入 **`IR` (指令寄存器)**，完成取指操作。

---

## 3. CPU 内部单总线方式 (02:19)

### 3.1 寄存器之间数据传送 (04:59)

#### 3.1.1 寄存器间数据传送的过程 (05:03)

* **传送原理**：通过使能相应的控制信号，导通寄存器与总线之间的连接通路，从而实现数据从一个寄存器流向另一个寄存器。
* **总线特性**：**总线 (Bus)** 是 CPU 内部公共的数据传输通道，就像公共汽车一样可被所有部件共享。但**同一时刻只能传输一个数据**，具有独占性。
* **示例 (PC 内容送至 MAR)**：需要两个步骤（通常在一个机器周期内的不同节拍完成）：
    1.  `PC_out` 信号有效，将 `PC` 的内容输出到**内部总线**。
    2.  `MAR_in` 信号有效，允许 `MAR` 从**内部总线**接收数据。
    * **数据流描述**：`(PC) → Bus` (表示 PC 内容送上总线)，`Bus → MAR` (表示总线内容送入 MAR)。

#### 3.1.2 数据传送中的控制信号标注 (06:45)

* **控制信号标注**：在描述数据流动时，**必须明确标明同时有效的控制信号**。这是考试中高频考点。例如，`PC → MAR` 的传送需要 `PC_out` 和 `MAR_in` 信号同时有效。
* **合并步骤**：部分题目允许将两步合并描述为 `(PC) → Bus → MAR`，但在答题时仍需注明所有必要的控制信号。

#### 3.1.3 数据流动描述的差异与注意 (07:06)

* **表示方法差异**：不同教材对寄存器内容的表示可能不同，有的用 `(PC)` 表示取出内容，有的直接写 `PC`。核心是**清晰准确地描述数据流向**。
* **考试注意**：具体题目可能有明确要求，若无特殊要求，**加括号的表示法 `(PC)` 更为严谨和稳妥**，表示“PC 的内容”。

### 3.2 主存与 CPU 之间的数据传送 (08:22)

#### 3.2.1 从主存读取指令的流程 (08:31)

这是一个典型的取指过程：
1.  `(PC) → MAR`（PC 内容送入 MAR）。
2.  `CU` 发出读命令（`MemR` 信号有效）。
3.  `MEM(MAR) → MDR`（主存根据 `MAR` 地址，将数据读入 `MDR`）。
4.  `(MDR) → IR`（`MDR` 内容送入 `IR`）。

#### 3.2.2 PC 内容传送到 MAR (08:42)

* **地址准备**：首先需要 `PC_out` 和 `MAR_in` 信号有效，将指令地址从 `PC` 送入 `MAR`。完成后，需要撤销这些控制信号，让总线空闲，以便进行后续操作。

#### 3.2.3 发出读信号与地址传送 (09:01)

* **读操作触发**：`CU` 通过**控制总线**向主存发出读信号（`MemR`）。同时，`MAR` 中的内容通过**地址总线**传送给主存。
* **隐含信号**：实际上，存在控制 `MAR` 信息送**地址总线**的信号，但某些简化的图示可能省略。

#### 3.2.4 数据从主存传送到 MDR (09:40)

* **数据接收**：主存通过**数据总线**将数据送入 `MDR`，这需要 `MDR_inE` 信号有效（这里的 `E` 表示外部总线输入）。
* **教材差异**：部分教材可能将 `MDR_in` 统一用于内部和外部总线输入，但在实际考试中，通常会**明确区分带 `E` 后缀的信号**表示与外部总线（系统总线）交互。

#### 3.2.5 数据从 MDR 传送到 IR (11:13)

* **指令存储**：需要 `MDR_out` 和 `IR_in` 信号有效，通过**内部总线**将 `MDR` 中的指令送入 `IR`，完成取指操作。

#### 3.2.6 数据传送的关键点总结 (11:56)

* **核心要素**：进行主存操作时，必须明确**主存操作地址**（存于 `MAR` 中）和**读写控制信号**（`MemR` 或 `MemW`）。
* **信号完整性**：答题时**不能遗漏 `CU` 发出的读写控制信号**，这是连接 CPU 内部控制逻辑与外部存储器的关键。

### 3.3 执行算术或逻辑运算 (12:25)

#### 3.3.1 加法指令的执行过程 (12:27)

以一条加法指令为例（如 `ADD (R0), R1`，表示 `R1 = (R0) + R1`，其中 `(R0)` 是指 `R0` 寄存器内容作为地址指向的内存单元内容）：

* **操作数准备**：在单总线结构中，ALU 需要两个操作数。如果一个操作数已在 `ACC` 或某个通用寄存器，另一个操作数由指令地址码指明（可能在内存中），则需要先将其读取到 `MDR`。

#### 3.3.2 操作数的读取与传送 (12:57)

* **地址传送**：如果操作数在内存中，其地址可能从 `IR` 的地址码部分或 `MDR` 中取出，并送入 `MAR`（分别需要 `Ad(IR)out` 和 `MARin` 或 `MDRout` 和 `MARin` 有效）。
* **数据暂存**：由于单总线限制，ALU 无法同时从总线获取两个操作数。因此，通常需要先将一个操作数（例如，来自 `ACC` 或 `R1`）暂存到**暂存寄存器 Y**，然后通过总线传送另一个操作数（例如，从内存读取到 `MDR` 后再送入 ALU）。

#### 3.3.3 ALU 的输入与运算 (15:05)

* **同步输入**：ALU 需要两个操作数**同时输入**。在单总线结构下，这需要分步完成：先将一个操作数暂存到 Y，然后将另一个操作数直接送到 ALU 的另一个输入端。
* **运算控制**：`CU` 需要向 `ALU` 发出具体的运算控制信号（如加法、减法等），指示 `ALU` 执行何种操作。

#### 3.3.4 运算结果的存储 (16:04)

* **结果回写**：`ALU` 的运算结果通常会先暂存到**暂存寄存器 Z**。然后，通过 `Z_out` 和目标寄存器（如 `ACC`）的 `ACC_in` 信号，将结果写回到目标寄存器。

#### 3.3.5 单总线与多总线的区别 (17:38)

* **设计权衡**：
    * **单总线**：成本较低，但效率较低（需要更多的时钟周期和暂存寄存器来完成操作，如 ALU 双操作数输入）。
    * **多总线**：成本较高，但可以支持**并行传输**，显著提高性能。
* **考试重点**：通常会考察**单总线结构**下的数据传输过程，因为其逻辑更复杂，更能体现对 CPU 内部工作原理的理解。

### 3.4 应用案例 (18:34)

#### 3.4.1 例题: 指令 `ADD (R0), R1` 的指令流程和控制信号分析

* **指令功能**：这条指令表示 `R1 = MEM[R0的内容] + R1`，即将 `R0` 寄存器内容所指向的内存单元中的数据，与 `R1` 寄存器中的数据相加，结果存回 `R1`。这涉及**寄存器间接寻址**。
* **执行阶段**：该指令的执行需要经过：**取指周期 → 间址周期 → 执行周期**。
* **关键信号**（简化示例，实际可能更复杂）：
    * **取指周期**：
        * `PC_out, MAR_in` (PC内容送MAR)
        * `MemR` (主存读)
        * `MDR_inE` (MDR接收外部数据)
        * `MDR_out, IR_in` (MDR内容送IR)
    * **间址周期** (获取 `(R0)` 的有效地址)：
        * `R0_out, MAR_in` (R0内容送MAR)
        * `MemR` (主存读)
        * `MDR_inE` (MDR接收外部数据)
        * `MDR_out, Ad(IR)_in` (MDR内容送IR地址码部分作为有效地址) - *这里可能根据指令设计将有效地址直接送入另一个寄存器或ALU*
    * **执行周期** (加法运算)：
        * `R1_out, Y_in` (R1内容暂存到Y)
        * `MDR_out, A_in` (间接寻址取到的数据送入ALU另一个输入端A)
        * `ALU_add` (ALU执行加法运算)
        * `Z_out, R1_in` (运算结果Z送入R1)
* **易错点**：注意间址周期是否需要读取实际数据（取决于指令是间接取地址还是间接取操作数，不同教材或指令集可能要求不同）。

---

## 4. 数据通路与总线结构 (27:43)

### 4.1 单总线结构

* **结构特点**：如前所述，同一时刻只能由一组部件通过总线进行数据传送。
* **ALU 操作限制**：由于 ALU 需要同时输入两个操作数，而单总线每次只能传输一个数据，因此**必须配合暂存寄存器 (Y)** 使用。
* **操作流程**：先将一个操作数（如来自 `ACC` 或 `R1`）存入暂存寄存器 Y，然后另一个操作数通过单总线直接输送给 ALU 的另一个输入端。
* **应用场景**：是 CPU 内部数据传输的一种经济但效率相对较低的公共通路。

### 4.2 多总线结构

* **结构优势**：多总线结构可以拥有多条并行的数据通路。例如，三总线结构可以同时向 ALU 输送两个操作数，并接收 ALU 的结果。
* **简化设计**：由于可以并行传输操作数，**不需要暂存寄存器 Y 的配合**即可正常工作，简化了控制逻辑。
* **性能对比**：相比单总线结构，多总线结构具有**更高的数据传输效率**和更好的并行性。

### 4.3 总线类型对比

* **内部总线**：CPU 内部用于数据传输的公共通路，连接 CPU 内部的寄存器、ALU、CU 等部件。
* **系统总线**：CPU、存储器、I/O 设备之间的公共数据通路，包括**地址总线、数据总线、控制总线**。
* **关键区别**：它们的**连接范围不同**。内部总线仅限 CPU 内部，系统总线连接整个计算机系统。

### 4.4 典型考点分析

* **微操作序列分析**：给定一条指令后，分析其在各个执行阶段所需的详细微操作步骤。
* **控制信号生成**：为每个微操作确定并标注相应的**控制信号**（由**控制单元 CU** 发出）。
* **考察重点**：理解不同总线结构下数据通路的实现差异，特别是单总线结构对数据传输的限制。

### 4.5 暂存寄存器的作用

* **必要性**：在**单总线结构**中，暂存寄存器 (如 Y) 是解决 ALU 双操作数输入问题的**关键部件**。
* **工作原理**：它临时存储一个操作数，等待另一个操作数通过总线传输到位，以便 ALU 可以同时获得两个输入。
* **性能影响**：虽然解决了问题，但它**增加了数据传输的步骤**（需要一个额外的时钟周期），从而降低了单总线结构下的运算效率。

---

## 二、知识小结

| 知识点              | 核心内容                                                     | 考试重点/易混淆点                                           | 难度系数 |
| :------------------ | :----------------------------------------------------------- | :---------------------------------------------------------- | :------- |
| CPU 数据通路功能    | 研究单总线结构下不同指令执行阶段的数据流动和控制信号实现。 | 控制信号的发出时机和数据流动路径。                          | ⭐⭐⭐⭐   |
| 指令执行阶段划分    | 指令周期被划分为不同阶段，数据流向可能不同。                 | 区分寄存器间、寄存器与主存间、寄存器与 ALU 间三种数据流动。 | ⭐⭐⭐     |
| 数据通路概念        | 数据在各功能部件间传送的路径。                               | 确定信息起点、经过部件和终点。                              | ⭐⭐       |
| 控制信号类型        | 分为输入控制信号和输出控制信号。                             | 区分 `ACC_in/out` 和 `R0_in/out` 等信号功能。             | ⭐⭐⭐     |
| 单总线结构特点      | 同一时刻只允许两个部件间进行数据交换。                       | 总线独占式使用与多总线结构对比。                            | ⭐⭐⭐⭐   |
| 内部总线 vs 系统总线 | 内部总线用于 CPU 内部数据传输，系统总线用于 CPU 与主存/IO 设备通信。 | 应用场景区分和传输路径差异。                                | ⭐⭐       |
| 寄存器间数据传送    | 通过控制 `out` 和 `in` 信号实现（如 `PC → MAR`）。           | `PC` 内容传递时括号使用规范 `(PC)`。                      | ⭐⭐⭐     |
| 主存与寄存器数据传送 | 需通过 `MAR` 指定地址，`CU` 发出读/写信号。                  | `MDR_in` 信号的双重含义（内部/外部总线）。                | ⭐⭐⭐⭐   |
| ALU 运算数据流动    | 需先将一个操作数存入**暂存寄存器 Y**。                       | 单总线结构下 ALU 输入限制与多总线方案对比。                 | ⭐⭐⭐⭐   |
| 加法指令执行流程    | 分为取指周期、间址周期和执行周期。                           | 间接寻址操作数获取和结果写回主存。                          | ⭐⭐⭐⭐⭐ |
| 微操作控制信号      | 每个时钟周期发出一组控制信号完成微操作。                     | 大题中控制信号的有效标注要求。                              | ⭐⭐⭐⭐   |
| 单总线与多总线对比  | 单总线成本低但效率低，多总线成本高但并行性好。               | **暂存寄存器 Y 的必要性分析**。                           | ⭐⭐⭐     |